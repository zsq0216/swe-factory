{"repo": "python-pillow/Pillow", "pull_number": 7412, "instance_id": "python-pillow__Pillow-7412", "issue_numbers": ["7411"], "base_commit": "4ecf1df4ea63457040f63adaeea35996913b6ac1", "patch": "diff --git a/src/PIL/ImageOps.py b/src/PIL/ImageOps.py\n--- a/src/PIL/ImageOps.py\n+++ b/src/PIL/ImageOps.py\n@@ -242,7 +242,7 @@ def contain(image, size, method=Image.Resampling.BICUBIC):\n     Returns a resized version of the image, set to the maximum width and height\n     within the requested size, while maintaining the original aspect ratio.\n \n-    :param image: The image to resize and crop.\n+    :param image: The image to resize.\n     :param size: The requested output size in pixels, given as a\n                  (width, height) tuple.\n     :param method: Resampling method to use. Default is\n@@ -266,6 +266,35 @@ def contain(image, size, method=Image.Resampling.BICUBIC):\n     return image.resize(size, resample=method)\n \n \n+def cover(image, size, method=Image.Resampling.BICUBIC):\n+    \"\"\"\n+    Returns a resized version of the image, so that the requested size is\n+    covered, while maintaining the original aspect ratio.\n+\n+    :param image: The image to resize.\n+    :param size: The requested output size in pixels, given as a\n+                 (width, height) tuple.\n+    :param method: Resampling method to use. Default is\n+                   :py:attr:`~PIL.Image.Resampling.BICUBIC`.\n+                   See :ref:`concept-filters`.\n+    :return: An image.\n+    \"\"\"\n+\n+    im_ratio = image.width / image.height\n+    dest_ratio = size[0] / size[1]\n+\n+    if im_ratio != dest_ratio:\n+        if im_ratio < dest_ratio:\n+            new_height = round(image.height / image.width * size[0])\n+            if new_height != size[1]:\n+                size = (size[0], new_height)\n+        else:\n+            new_width = round(image.width / image.height * size[1])\n+            if new_width != size[0]:\n+                size = (new_width, size[1])\n+    return image.resize(size, resample=method)\n+\n+\n def pad(image, size, method=Image.Resampling.BICUBIC, color=None, centering=(0.5, 0.5)):\n     \"\"\"\n     Returns a resized and padded version of the image, expanded to fill the\n", "test_patch": "diff --git a/Tests/test_imageops.py b/Tests/test_imageops.py\n--- a/Tests/test_imageops.py\n+++ b/Tests/test_imageops.py\n@@ -39,6 +39,9 @@ def test_sanity():\n     ImageOps.contain(hopper(\"L\"), (128, 128))\n     ImageOps.contain(hopper(\"RGB\"), (128, 128))\n \n+    ImageOps.cover(hopper(\"L\"), (128, 128))\n+    ImageOps.cover(hopper(\"RGB\"), (128, 128))\n+\n     ImageOps.crop(hopper(\"L\"), 1)\n     ImageOps.crop(hopper(\"RGB\"), 1)\n \n@@ -119,6 +122,20 @@ def test_contain_round():\n     assert new_im.height == 5\n \n \n+@pytest.mark.parametrize(\n+    \"image_name, expected_size\",\n+    (\n+        (\"colr_bungee.png\", (1024, 256)),  # landscape\n+        (\"imagedraw_stroke_multiline.png\", (256, 640)),  # portrait\n+        (\"hopper.png\", (256, 256)),  # square\n+    ),\n+)\n+def test_cover(image_name, expected_size):\n+    with Image.open(\"Tests/images/\" + image_name) as im:\n+        new_im = ImageOps.cover(im, (256, 256))\n+        assert new_im.size == expected_size\n+\n+\n def test_pad():\n     # Same ratio\n     im = hopper()\n", "problem_statement": "Function to downscale to minimum size\n<!--\r\nThank you for reporting an issue.\r\n\r\nFollow these guidelines to ensure your issue is handled properly.\r\n\r\nIf you have a ...\r\n\r\n1.  General question: consider asking the question on Stack Overflow\r\n    with the python-imaging-library tag:\r\n\r\n    * https://stackoverflow.com/questions/tagged/python-imaging-library\r\n\r\n    Do not ask a question in both places.\r\n\r\n    If you think you have found a bug or have an unexplained exception\r\n    then file a bug report here.\r\n\r\n2.  Bug report: include a self-contained, copy-pastable example that\r\n    generates the issue if possible. Be concise with code posted.\r\n    Guidelines on how to provide a good bug report:\r\n\r\n    * https://stackoverflow.com/help/mcve\r\n\r\n    Bug reports which follow these guidelines are easier to diagnose,\r\n    and are often handled much more quickly.\r\n\r\n3.  Feature request: do a quick search of existing issues\r\n    to make sure this has not been asked before.\r\n\r\nWe know asking good questions takes effort, and we appreciate your time.\r\nThank you.\r\n-->\r\n\r\n### What do you want to do?\r\n\r\nI want to downscale/resize an image to a minimum size without changing its aspect ratio. This could be useful for shrinking large profile pictures, or shrinking an image to save processing time during future operations on an image.\r\n\r\n### How would you expect it to be implemented?\r\n\r\nI'd like to call a function on an `Image` object, like `downscale_to_min(img, min_width, min_height)`. \r\n\r\nExample:\r\n```python\r\nimg = Image.open(\"filepath/to/my/picture.png\")\r\nprint(img.size) # (1400, 100)\r\nimg.downscale_to_min(500, 500)\r\nprint(img.size) # (700, 500)\r\n```\r\n\r\n### Any context?\r\n\r\nThere a similar function to this, `thumbnail()`, where you set the _maximum_ size to scale an image to. It's like drawing a box around an image, and making sure no side of the image grows over the borders. I tried to visualize it here, red are the borders (the maximum size passed to `thumbnail()`, and green is the image:\r\n\r\n<details><summary>Click to expand</summary>\r\n\r\n![Thumbnail](https://github.com/python-pillow/Pillow/assets/119804311/289bd185-8ae7-4189-bf76-321b2f3f7630)\r\n\r\n</details>\r\n\r\nThis function would be similar, except the box is now on the inside of the image, and the no side can shrink _under_ the borders\r\nAgain, visualized:\r\n\r\n<details><summary>Click to expand</summary>\r\n\r\n![Down to min](https://github.com/python-pillow/Pillow/assets/119804311/f544d4fb-c55b-4ae7-bc11-a438adeb2633)\r\n\r\n</details>\r\n\r\n### What are your OS, Python and Pillow versions?\r\n\r\n* OS: Fedora Linux 38\r\n* Python: 3.11\r\n* Pillow: 10.0.1\r\n\r\n<!--\r\nPlease include **code** that reproduces the issue and whenever possible, an **image** that demonstrates the issue. Please upload images to GitHub, not to third-party file hosting sites. If necessary, add the image to a zip or tar archive.\r\n\r\nThe best reproductions are self-contained scripts with minimal dependencies. If you are using a framework such as Plone, Django, or Buildout, try to replicate the issue just using Pillow.\r\n-->\r\n\r\nThis is a basic function that implements the functionality using existing PIL functions.\r\n\r\n```python\r\ndef downscale_to_min(img, min_width, min_height):\r\n    desired_ratio = min_height / min_width\r\n    img_ratio = img.height / img.width\r\n\r\n    if img_ratio > desired_ratio:\r\n        desired_height = min_height\r\n        downscale_factor = min_height / img.height\r\n        desired_width = img.width * downscale_factor\r\n\r\n    else:\r\n        desired_width = min_width\r\n        downscale_factor = min_width / img.width\r\n        desired_height = img.height * downscale_factor\r\n\r\n    img.resize((desired_width, desired_height))\r\n```\r\n\n", "hints_text": "I think that `ImageOps` is a better home for this than `Image`, since we have similar methods there already. I've created PR #7412 to add the new function.", "created_at": "2023-09-21T01:48:54Z", "version": "10.0"}
{"repo": "mochajs/mocha", "pull_number": 4068, "instance_id": "mochajs__mocha-4068", "issue_numbers": ["4022"], "base_commit": "d9f5079b3b26c61fec3329a902dea00ccc961f70", "patch": "diff --git a/lib/reporters/base.js b/lib/reporters/base.js\n--- a/lib/reporters/base.js\n+++ b/lib/reporters/base.js\n@@ -154,14 +154,14 @@ exports.cursor = {\n   }\n };\n \n-function showDiff(err) {\n+var showDiff = (exports.showDiff = function(err) {\n   return (\n     err &&\n     err.showDiff !== false &&\n     sameType(err.actual, err.expected) &&\n     err.expected !== undefined\n   );\n-}\n+});\n \n function stringifyDiffObjs(err) {\n   if (!utils.isString(err.actual) || !utils.isString(err.expected)) {\n@@ -182,9 +182,19 @@ function stringifyDiffObjs(err) {\n  * @return {string} Diff\n  */\n var generateDiff = (exports.generateDiff = function(actual, expected) {\n-  return exports.inlineDiffs\n-    ? inlineDiff(actual, expected)\n-    : unifiedDiff(actual, expected);\n+  try {\n+    return exports.inlineDiffs\n+      ? inlineDiff(actual, expected)\n+      : unifiedDiff(actual, expected);\n+  } catch (err) {\n+    var msg =\n+      '\\n      ' +\n+      color('diff added', '+ expected') +\n+      ' ' +\n+      color('diff removed', '- actual:  failed to generate Mocha diff') +\n+      '\\n';\n+    return msg;\n+  }\n });\n \n /**\ndiff --git a/lib/reporters/xunit.js b/lib/reporters/xunit.js\n--- a/lib/reporters/xunit.js\n+++ b/lib/reporters/xunit.js\n@@ -163,9 +163,9 @@ XUnit.prototype.test = function(test) {\n   if (test.state === STATE_FAILED) {\n     var err = test.err;\n     var diff =\n-      Base.hideDiff || !err.actual || !err.expected\n-        ? ''\n-        : '\\n' + Base.generateDiff(err.actual, err.expected);\n+      !Base.hideDiff && Base.showDiff(err)\n+        ? '\\n' + Base.generateDiff(err.actual, err.expected)\n+        : '';\n     this.write(\n       tag(\n         'testcase',\n", "test_patch": "diff --git a/test/reporters/xunit.spec.js b/test/reporters/xunit.spec.js\n--- a/test/reporters/xunit.spec.js\n+++ b/test/reporters/xunit.spec.js\n@@ -350,6 +350,42 @@ describe('XUnit reporter', function() {\n           '</failure></testcase>';\n         expect(expectedWrite, 'to be', expectedTag);\n       });\n+\n+      it('should handle non-string diff values', function() {\n+        var runner = new EventEmitter();\n+        createStatsCollector(runner);\n+        var xunit = new XUnit(runner);\n+\n+        var expectedTest = {\n+          state: STATE_FAILED,\n+          title: expectedTitle,\n+          parent: {\n+            fullTitle: function() {\n+              return expectedClassName;\n+            }\n+          },\n+          duration: 1000,\n+          err: {\n+            actual: 1,\n+            expected: 2,\n+            message: expectedMessage,\n+            stack: expectedStack\n+          }\n+        };\n+\n+        sandbox.stub(xunit, 'write').callsFake(function(str) {\n+          expectedWrite += str;\n+        });\n+\n+        runner.emit(EVENT_TEST_FAIL, expectedTest, expectedTest.err);\n+        runner.emit(EVENT_RUN_END);\n+        sandbox.restore();\n+\n+        var expectedDiff =\n+          '\\n      + expected - actual\\n\\n      -1\\n      +2\\n      ';\n+\n+        expect(expectedWrite, 'to contain', expectedDiff);\n+      });\n     });\n \n     describe('on test pending', function() {\n", "problem_statement": "reporter xunit output report incomplete\n### Prerequisites\r\n\r\n- [X] Checked that your issue hasn't already been filed by cross-referencing [issues with the `faq` label](https://github.com/mochajs/mocha/issues?utf8=%E2%9C%93&q=is%3Aissue%20label%3Afaq%20)\r\n- [X] Checked next-gen ES issues and syntax problems by using the same environment and/or transpiler configuration without Mocha to ensure it isn't just a feature that actually isn't supported in the environment in question or a bug in your code.\r\n- [X] 'Smoke tested' the code to be tested by running it outside the real test suite to get a better sense of whether the problem is in the code under test, your usage of Mocha, or Mocha itself\r\n- [X] Ensured that there is no discrepancy between the locally and globally installed versions of Mocha. You can find them with: `node node_modules/.bin/mocha --version`(Local) and `mocha --version`(Global). We recommend that you _not_ install Mocha globally.\r\n\r\n### Description\r\n\r\nWe are using hippie to test our components. During the request assertion, if the test fails, the output does not display the entire report. Not event the failed test nor the next tests.\r\n```\r\n<testsuite name=\"Mocha Tests\" tests=\"3\" failures=\"0\" errors=\"1\" skipped=\"0\" timestamp=\"Tue, 17 Sep 2019 13:26:17 GMT\" time=\"0.378\">\r\n<testcase classname=\"test\" name=\"test ok\" time=\"0.001\"/>\r\n// missing testsuite end tag.\r\n```\r\n### Steps to Reproduce\r\n\r\n```js\r\n\"use strict\";\r\n\r\nconst {expect} = require(\"chai\");\r\nconst hippie = require(\"hippie\");\r\n\r\ndescribe(\"test\", function() {\r\n\tit(\"test ok\", function(){\r\n\t\texpect(true).to.be.equal(true);\r\n\t})\r\n\tit(\"test ko\", function(){\r\n\t\treturn hippie()\r\n\t\t\t.base(\"https://mochajs.org\")\r\n\t\t\t.get(\"/not_found\")\r\n\t\t\t.expectStatus(200)\r\n\t\t\t.end();\r\n\t})\r\n\tit(\"test ok\", function(){\r\n\t\texpect(true).to.be.equal(true);\r\n\t})\r\n})\r\n```\r\n\r\nTest report with spec reporter shows succesfully:\r\n\r\n`$ npx mocha test.js --reporter spec`\r\n\r\n```\r\n    test\r\n    ✓ test ok\r\n    1) test ko\r\n    ✓ test ok\r\n\r\n\r\n  2 passing (204ms)\r\n  1 failing\r\n\r\n  1) test\r\n       test ko:\r\n     AssertionError: Status code\r\n\r\n    Actual:   404\r\n    Expected: 200\r\n\r\n      at assert (node_modules/hippie/lib/hippie/assert.js:36:10)\r\n      at statusCode (node_modules/hippie/lib/hippie/expect.js:23:10)\r\n      at verify (node_modules/hippie/lib/hippie/client.js:476:5)\r\n      at Client.verify (node_modules/hippie/lib/hippie/client.js:477:5)\r\n      at /home/sbesson/GIT/TMP/node_modules/hippie/lib/hippie/client.js:437:12\r\n      at Client.exports.raw [as parse] (node_modules/hippie/lib/hippie/parsers.js:33:3)\r\n      at Request._callback (node_modules/hippie/lib/hippie/client.js:435:10)\r\n      at Request.self.callback (node_modules/request/request.js:185:22)\r\n      at Request.<anonymous> (node_modules/request/request.js:1157:10)\r\n      at IncomingMessage.<anonymous> (node_modules/request/request.js:1079:12)\r\n      at endReadableNT (_stream_readable.js:1129:12)\r\n      at process._tickCallback (internal/process/next_tick.js:63:19)\r\n```\r\n\r\nBut with xunit reporter:\r\n`npx mocha test.js --reporter xunit`\r\n\r\n```\r\n<testsuite name=\"Mocha Tests\" tests=\"3\" failures=\"0\" errors=\"1\" skipped=\"0\" timestamp=\"Tue, 17 Sep 2019 13:33:12 GMT\" time=\"0.195\">\r\n<testcase classname=\"test\" name=\"test ok\" time=\"0.001\"/>\r\n```\r\n\r\n**Expected behavior:** [What you expect to happen]\r\nWe expect an output looking like this:\r\n```\r\n<testsuite name=\"Mocha Tests\" tests=\"3\" failures=\"0\" errors=\"1\" skipped=\"0\" timestamp=\"Tue, 17 Sep 2019 13:37:42 GMT\" time=\"0.251\">\r\n<testcase classname=\"test\" name=\"test ok\" time=\"0.001\"/>\r\n<testcase classname=\"test\" name=\"test ko\" time=\"0\"><failure>expected 404 to equal 200\r\n\r\n      + expected - actual\r\n\r\n      -404\r\n      +200\r\n      \r\nAssertionError: expected 404 to equal 200\r\n    at /home/sbesson/GIT/TMP/test.js:16:31\r\n    at verify (node_modules/hippie/lib/hippie/client.js:475:32)\r\n    at Client.verify (node_modules/hippie/lib/hippie/client.js:477:5)\r\n    at /home/sbesson/GIT/TMP/node_modules/hippie/lib/hippie/client.js:437:12\r\n    at Client.exports.raw [as parse] (node_modules/hippie/lib/hippie/parsers.js:33:3)\r\n    at Request._callback (node_modules/hippie/lib/hippie/client.js:435:10)\r\n    at Request.self.callback (node_modules/request/request.js:185:22)\r\n    at Request.&#x3C;anonymous&#x3E; (node_modules/request/request.js:1157:10)\r\n    at IncomingMessage.&#x3C;anonymous&#x3E; (node_modules/request/request.js:1079:12)\r\n    at endReadableNT (_stream_readable.js:1129:12)\r\n    at process._tickCallback (internal/process/next_tick.js:63:19)</failure></testcase>\r\n<testcase classname=\"test\" name=\"test ok\" time=\"0\"/>\r\n</testsuite>\r\n```\r\n\r\n**Actual behavior:** [What actually happens]\r\n```\r\n<testsuite name=\"Mocha Tests\" tests=\"3\" failures=\"0\" errors=\"1\" skipped=\"0\" timestamp=\"Tue, 17 Sep 2019 13:33:12 GMT\" time=\"0.195\">\r\n<testcase classname=\"test\" name=\"test ok\" time=\"0.001\"/>\r\n```\r\n\r\n**Reproduces how often:** [What percentage of the time does it reproduce?]\r\n100%\r\n\r\n### Versions\r\n\r\n* node : 10.16.0\r\n* mocha : 6.2.0\r\n* hippie : 0.5.2\r\n\r\n* OS : Linux Mint 19.1 Tessa\r\n* architecture : 64-bit\r\n* shell : bash\r\n\r\n### Additional Information\r\n\r\nIt works just fine with mocha@5.2.0.\r\n\r\n\r\nBest regards.\n", "hints_text": "Please run the same test again and write the output to a file, see [docu](https://mochajs.org/#xunit). It's important to know wether the file output is correct or truncated as well.\nHi, I am Serge's colleague.\r\n\r\nThe output is truncated as well.\r\n\r\n[report-output.zip](https://github.com/mochajs/mocha/files/3626331/report-output.zip)\r\n\nIt appears the output doesn't show up because the reporter crashes at [this line](https://github.com/mochajs/mocha/blob/master/lib/reporters/base.js#L424), which means it's actually a problem in the `diff` package. The exception that is thrown is `TypeError: value.split is not a function`.\r\n\r\nEdit: the expected result is achieved when casting both the expected and actual values to strings first. Seems `diff` was having trouble with `number` type values.", "created_at": "2019-10-14T20:55:10Z", "version": "6.2"}
